name: Release

on:
  push:
    tags:
      - 'rel/v*'
  release:
    types: [published]

jobs:
  ci:
    # Trigger on either a tag push or a release publication
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/rel/v')
    uses: gethnet/litellm-connector-copilot/.github/workflows/ci.yml@main
    secrets: inherit

  create-draft-release:
    needs: ci
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Verify Version Match
        run: |
          PACKAGE_VERSION=${{ needs.ci.outputs.version }}
          TAG_VERSION=${GITHUB_REF#refs/tags/rel/v}
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Tag version $TAG_VERSION does not match package.json version $PACKAGE_VERSION"
            exit 1
          fi

      - name: Download VSIX
        uses: actions/download-artifact@v7
        with:
          name: vsix
          path: .

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          files: "litellm-connector-copilot-${{ needs.ci.outputs.version }}.vsix"
          draft: true
          prerelease: ${{ contains(needs.ci.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-marketplace:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download VSIX from Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          if [ -z "$TAG_NAME" ]; then
            echo "Missing tag name from release event"
            exit 1
          fi
          if [[ ! "$TAG_NAME" =~ ^rel/v ]]; then
            echo "Release tag must start with rel/v. Got: $TAG_NAME"
            exit 1
          fi

          # Download the VSIX asset attached to the draft release
          gh release download "$TAG_NAME" --pattern "litellm-connector-copilot-*.vsix" --dir .

          # Validate exactly one VSIX file was downloaded
          VSIX_COUNT=$(ls -1 litellm-connector-copilot-*.vsix 2>/dev/null | wc -l)
          if [ "$VSIX_COUNT" -ne 1 ]; then
            echo "Expected exactly one VSIX asset, found $VSIX_COUNT"
            ls -l litellm-connector-copilot-*.vsix 2>/dev/null || true
            exit 1
          fi

          VSIX_FILE=$(ls -1 litellm-connector-copilot-*.vsix)
          FILE_VERSION=${VSIX_FILE#litellm-connector-copilot-}
          FILE_VERSION=${FILE_VERSION%.vsix}

          TAG_VERSION=${TAG_NAME#rel/v}
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "VSIX version $FILE_VERSION does not match tag version $TAG_VERSION"
            exit 1
          fi

          echo "VSIX_FILE=$VSIX_FILE" >> $GITHUB_ENV

      - name: Publish to VS Code Marketplace
        if: |
          !contains(github.event.release.tag_name, 'dev') &&
          !contains(github.event.release.tag_name, 'test')
        run: npx vsce publish --packagePath "$VSIX_FILE" -p ${{ secrets.VS_MARKETPLACE_PUB_TOKEN }} --no-dependencies

      - name: Publish to Open VSX Registry
        if: |
          !contains(github.event.release.tag_name, 'dev') &&
          !contains(github.event.release.tag_name, 'test')
        env:
          OPENVSX_TOKEN: ${{ secrets.OPENVSX_REGISTRY }}
        run: npx ovsx publish "$VSIX_FILE" -p "$OPENVSX_TOKEN"
